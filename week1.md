# 容器

Linux容器本质上是利用cgroups和Namespace机制与系统其他部分隔离开的一个或一组进程，而运行这些进程所需的文件由另一个镜像提供。因此，对容器行为的监控本质上就是对进程行为的监控。当然，这之中会有一些细节上的差异。下一阶段我们将初步实现对目标进程的监测，在后续的开发中使之更适用于容器的监测。

监控的核心内容是进程的各种系统调用，以及网络包的收发，这些在eBPF技术中都有成熟的接口可以利用。

# eBPF开发原理

eBPF支持在用户态将C语言编写的一小段“内核代码”注入到内核中运行，注入时要先用llvm编译得到使用BPF指令集的elf文件，然后从elf文件中解析出可以注入内核的BPF字节码，最后用`bpf_load_program()`方法完成注入。 用户态程序和注入到内核中的程序通过共用一个位于内核中map实现通信。为了防止注入的代码导致内核崩溃，eBPF会对注入的代码进行严格检查，拒绝不合格的代码的注入。

<div align="center">
<img src="./ebpf.png" />
<p>eBPF整体架构</p>
</div>

注入内核的eBPF代码可以利用Linux提供的kprobe/uprobe和tracepoint等机制，对特定的事件进行实时监测和控制。比如`BPF_PROG_TYPE_CGROUP_SKB`或`BPF_PROG_TYPE_CGROUP_SOCK`类型的eBPF程序可以在cgroup级别进行网络流量的控制，这正符合本项目要实现的对容器网络通信监测的要求。

>在<a href="https://arthurchiao.art/blog/bpf-advanced-notes-1-zh/#cgroup-v2-%E7%9B%B8%E5%85%B3%E7%B1%BB%E5%9E%8B">这篇文章</a>中有更多关于cgroup的eBPF程序类型的介绍，可后续开发中作为参考

# 开发方式

项目计划使用golang的<a href="https://github.com/cilium/ebpf">cilium/ebpf</a>库进行开发，有如下优势：

+ cilium/ebpf用纯go编写，实现了程序最小依赖
+ bpf2go工具能将eBPF程序编译为go中的一部分，交付更为方便
+ 相较于纯C开发，后续加入各项功能更为方便（如json的处理等）
+ 相较于BCC开发，部署分发更为方便，后续可以考虑配合CO-RE增加可移植性

一个已有的<a href="https://github.com/ehids/ecapture">可参考项目</a>

# 下阶段计划

由于本周工作的重点在于厘清各种概念，确定整个开发的基础框架，寻找可参考的范例等前置工作，所以暂时还没有遇到棘手的问题。

下一周将进行初步的代码编写工作，计划是能写出一个监测目标进程某些系统调用（如open，read等）的简单程序。在编写的过程中，应当进一步思考完善项目架构的细节，广泛查阅开发所需api的用法。

上述工作有进展之后，会查阅资料或询问指导老师，以确定项目要实现的具体功能，并着手进行各模块的监测，文件生成等内容的编写。